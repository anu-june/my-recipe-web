name: Database Backup

on:
  schedule:
    # Run monthly on the 1st at midnight UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-common
          # Install the specific version repository script
          sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
          sudo apt-get install -y postgresql-client-17

      - name: Create Database Backup
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          # Create a timestamped filename
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          FILENAME="backup_${TIMESTAMP}.sql"
          
          # Run pg_dump
          # -Fc: Custom format (compressed)
          # -d: Database URL
          pg_dump -d "$SUPABASE_DB_URL" -f "$FILENAME"
          
          echo "BACKUP_FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ env.BACKUP_FILENAME }}
          path: ${{ env.BACKUP_FILENAME }}
          retention-days: 90
